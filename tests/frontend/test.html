<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Unit Tests - Zhuyin Practice</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 2rem; }
        .test-suite {
            background: white;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 4px;
        }
        .pass {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .fail {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .summary {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 2rem;
            padding: 1rem;
            background: #e9ecef;
            border-radius: 4px;
        }
        #keyboard { display: none; } /* Hide keyboard rendered during tests */
    </style>
</head>
<body>
    <h1>Frontend Unit Tests</h1>
    <div id="test-results"></div>
    <div id="summary" class="summary"></div>
    
    <!-- Hidden containers for testing -->
    <div id="keyboard"></div>
    <div id="practice-word"></div>
    <div id="target-zhuyin"></div>

    <script type="module">
        import { keyToZhuyin, zhuyinToKey, isZhuyinKey, getZhuyin, getKey } from '../js/modules/zhuyin-map.js';
        import * as keyboard from '../js/modules/keyboard.js';
        import * as practice from '../js/modules/practice.js';

        const results = [];
        const resultsContainer = document.getElementById('test-results');

        function assert(condition, testName) {
            const passed = Boolean(condition);
            results.push({ name: testName, passed });
            
            const div = document.createElement('div');
            div.className = `test-result ${passed ? 'pass' : 'fail'}`;
            div.textContent = `${passed ? '✓' : '✗'} ${testName}`;
            resultsContainer.appendChild(div);
            
            if (!passed) {
                console.error('Test failed:', testName);
            }
        }

        function testSuite(name, tests) {
            const suite = document.createElement('div');
            suite.className = 'test-suite';
            const title = document.createElement('h2');
            title.textContent = name;
            resultsContainer.appendChild(title);
            resultsContainer.appendChild(suite);
            
            tests();
        }

        // Test Suite 1: keyToZhuyin mapping completeness
        testSuite('Test 1: keyToZhuyin Mapping Completeness', () => {
            // Test consonants
            assert(keyToZhuyin['1'] === 'ㄅ', 'Consonant ㄅ maps from key 1');
            assert(keyToZhuyin['s'] === 'ㄋ', 'Consonant ㄋ maps from key s');
            assert(keyToZhuyin['g'] === 'ㄕ', 'Consonant ㄕ maps from key g');
            
            // Test vowels
            assert(keyToZhuyin['u'] === 'ㄧ', 'Vowel ㄧ maps from key u');
            assert(keyToZhuyin['j'] === 'ㄨ', 'Vowel ㄨ maps from key j');
            assert(keyToZhuyin['8'] === 'ㄚ', 'Vowel ㄚ maps from key 8');
            
            // Test tones
            assert(keyToZhuyin[' '] === '', 'First tone maps from space key');
            assert(keyToZhuyin['6'] === 'ˊ', 'Second tone ˊ maps from key 6');
            assert(keyToZhuyin['3'] === 'ˇ', 'Third tone ˇ maps from key 3');
            assert(keyToZhuyin['4'] === 'ˋ', 'Fourth tone ˋ maps from key 4');
            assert(keyToZhuyin['7'] === '˙', 'Fifth tone ˙ maps from key 7');
            
            // Test reverse mapping
            assert(zhuyinToKey['ㄅ'] === '1', 'Reverse mapping: ㄅ → 1');
            assert(zhuyinToKey['ㄋ'] === 's', 'Reverse mapping: ㄋ → s');
            assert(zhuyinToKey['ˇ'] === '3', 'Reverse mapping: ˇ → 3');
            
            // Test utility functions
            assert(isZhuyinKey('s'), 'isZhuyinKey recognizes valid key');
            assert(!isZhuyinKey('z'), 'isZhuyinKey rejects invalid key (incorrect - z is valid)');
            assert(getZhuyin('s') === 'ㄋ', 'getZhuyin returns correct symbol');
            assert(getKey('ㄋ') === 's', 'getKey returns correct key');
        });

        // Test Suite 2: Keyboard highlighting
        testSuite('Test 2: Keyboard Highlighting', () => {
            // Render keyboard first
            keyboard.render();
            
            // Test that keyboard was rendered
            const keyElements = document.querySelectorAll('.key');
            assert(keyElements.length > 0, 'Keyboard renders with keys');
            
            // Test highlighting a key
            keyboard.highlightKey('s');
            const highlightedKey = document.querySelector('.key.highlighted');
            assert(highlightedKey !== null, 'highlightKey() adds highlighted class');
            assert(highlightedKey.dataset.key === 's', 'Correct key is highlighted');
            
            // Test clearing highlight
            keyboard.clearHighlight();
            const stillHighlighted = document.querySelector('.key.highlighted');
            assert(stillHighlighted === null, 'clearHighlight() removes highlighted class');
            
            // Test highlighting spacebar
            keyboard.highlightKey(' ');
            const spaceKey = document.querySelector('.key[data-key=" "]');
            assert(spaceKey.classList.contains('highlighted'), 'Spacebar can be highlighted');
            keyboard.clearHighlight();
        });

        // Test Suite 3: Practice validation logic
        testSuite('Test 3: Practice Input Validation', () => {
            // Load a test word
            const testWord = {
                word: '你',
                zhuyin: ['ㄋ', 'ㄧ', 'ˇ'],
                keys: ['s', 'u', '3']
            };
            practice.loadWord(testWord);
            
            // Test correct input sequence
            let result = practice.checkInput('s');
            assert(result.correct === true, 'First input (s) is correct');
            assert(result.complete === false, 'Word not yet complete after first input');
            
            result = practice.checkInput('u');
            assert(result.correct === true, 'Second input (u) is correct');
            assert(result.complete === false, 'Word not yet complete after second input');
            
            result = practice.checkInput('3');
            assert(result.correct === true, 'Third input (3) is correct');
            assert(result.complete === true, 'Word complete after final input');
            
            // Test incorrect input
            practice.loadWord(testWord);
            result = practice.checkInput('a'); // Wrong key
            assert(result.correct === false, 'Incorrect input is rejected');
            assert(result.complete === false, 'Word not complete on wrong input');
            
            // Correct input should still work
            result = practice.checkInput('s');
            assert(result.correct === true, 'Correct input works after wrong input');
        });

        // Test Suite 4: First tone handling
        testSuite('Test 4: First Tone Handling (Space and Auto-advance)', () => {
            // Test word with first tone (space)
            const wordWithFirstTone = {
                word: '的',
                zhuyin: ['ㄉ', 'ㄜ', ''],
                keys: ['2', '9', ' ']
            };
            practice.loadWord(wordWithFirstTone);
            
            // Input first two keys
            practice.checkInput('2');
            practice.checkInput('9');
            
            // Test explicit space for first tone
            let result = practice.checkInput(' ');
            assert(result.correct === true, 'Space key accepted for first tone');
            assert(result.complete === true, 'Word complete with explicit space');
            
            // Test auto-advance (starting new word without space)
            practice.loadWord(wordWithFirstTone);
            practice.checkInput('2');
            practice.checkInput('9');
            
            result = practice.checkInput('s'); // Start next word
            assert(result.correct === true, 'Auto-advance works for first tone');
            assert(result.complete === true, 'Word marked complete on auto-advance');
            assert(result.autoAdvance === true, 'autoAdvance flag is set');
            assert(result.nextKey === 's', 'Next key is preserved');
        });

        // Test Suite 5: DOM updates
        testSuite('Test 5: DOM Display Updates', () => {
            const testWord = {
                word: '好',
                zhuyin: ['ㄏ', 'ㄠ', 'ˇ'],
                keys: ['c', 'l', '3']
            };
            
            practice.loadWord(testWord);
            
            const wordDisplay = document.getElementById('practice-word');
            const zhuyinDisplay = document.getElementById('target-zhuyin');
            
            assert(wordDisplay.textContent === '好', 'Word display updated correctly');
            assert(zhuyinDisplay.textContent === 'ㄏㄠˇ', 'Zhuyin display updated correctly');
        });

        // Show summary
        const passed = results.filter(r => r.passed).length;
        const failed = results.filter(r => !r.passed).length;
        const total = results.length;
        
        const summary = document.getElementById('summary');
        summary.innerHTML = `
            <strong>Test Summary:</strong><br>
            Total: ${total} | Passed: ${passed} | Failed: ${failed}<br>
            ${failed === 0 ? '✓ All tests passed!' : `✗ ${failed} test(s) failed`}
        `;
        summary.style.color = failed === 0 ? '#155724' : '#721c24';
        summary.style.background = failed === 0 ? '#d4edda' : '#f8d7da';
    </script>
</body>
</html>
